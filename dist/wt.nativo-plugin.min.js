/**
 * videojs-wt-nativo-plugin
 * @version 1.0.4
 * @copyright 2017 Watching That Ltd
 * @license Commercial
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.videojsWtAdTracerBCPlugin=t()}(this,function(){"use strict";var e=!1,t={set debug(t){e=t},log:function(){if(e)try{for(var t,i=arguments.length,r=Array(i),o=0;o<i;o++)r[o]=arguments[o];(t=console).log.apply(t,["%cWTAT","background:#ffd400;color:#000;padding:2px"].concat(r))}catch(e){}},logGroup:function(t){if(e)try{console.groupCollapsed("WTAT: "+t);for(var i=arguments.length,r=Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];r[0].forEach(function(e){if(Array.isArray(e)){var t;(t=console).log.apply(t,e)}else console.log(e)}),console.groupEnd()}catch(e){}}},i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),o=function(){function e(r,o,a){var n=this,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,d=arguments.length>4&&void 0!==arguments[4]&&arguments[4];i(this,e),this.player=null,this.adManagerWrapper=null,this.videoSlot=null,this.debug=!1,this.options={},this.originalAdURLIsPlayer=!1,this.wtUrl="https://c.watchingthat.com/event",this.sads={},this.onVPAIDEvent=function(e,i){t.log("start.onVPAIDEvent",e);var r=void 0;["sa","ecp","efq","esq","etq","eimp"].includes(e)?(r=n.gatherData(e,null,i),n.sendDataToWT(r)):t.log("Ignored event",e)},this.onAdError=function(e){t.log("start.onAdError");var i=e.originalEvent;if(i&&i.getError){var r=i.getError(),o=r.getVastErrorCode(),a=n.gatherData("err",o);t.log("IMA threw an error",r),t.log("ERROR: VAST CODE",o),n.sendDataToWT(a)}else t.log("onAdError originalEvent does not look like an ima3 event",e)},this.getWindowWH=function(){t.log("start.getWindowWH");var e=0,i=0,r=0,o=void 0;try{e=(o=n.getViewPortSize(window.top)).width,i=o.height,r=1}catch(e){t.log("getWindowWH ERROR 1:",e.message)}if(!e){var a=window;try{for(;a.parent&&a!==a.parent;)e=(o=n.getViewPortSize(window.parent)).width,i=o.height,a=a.parent}catch(e){t.log("getWindowWH ERROR 2:",e.message)}}return[e,i,r]},this.gatherData=function(e,i,r){t.log("start.gatherData",e,i,r);var o=n.getWindowWH(),a=n.getVisibleState(),l=void 0;l=a.error?-1:a.percentViewable||-1;var d={src:n.adManagerWrapper.SHORT_NAME||"plug",clientId:n.options.clientId,clientSecret:n.options.clientSecret,rid:n.sessionId,per:l,ww:o[0],wh:o[1],fif:o[2],cst:Date.now()};t.log("data0");var s=document.referrer;try{window.location===window.parent.location&&(s=document.location.href)}catch(e){t.log("gatherData pu set to referrer:",s,e.message)}d.pu=s,n.sads[n.originalAdURL]?d.sad=n.sads[n.originalAdURL]:(d.adURL=n.originalAdURL,d.urlIsPlayer=n.originalAdURLIsPlayer),e&&(d.st=e),i&&(d.err=i);try{var c=n.videoSlot.getBoundingClientRect();d.w=c.width,d.h=c.height}catch(e){t.log("gatherData ERROR reading ad WxH:",e.message)}return t.log("data1"),r&&(d.adId=r.adId,d.adSys=r.adSystem,d.adAN=r.advertiserName,d.adDID=r.dealId,d.adWId=r.wrapperAdIds,d.adWSys=r.wrapperAdSystems),t.log("data2",d),d},this.sendDataToWT=function(e,i){if(t.log("start.sendDataToWT",n.wtUrl),n.wtUrl){var r=void 0;if(window.XMLHttpRequest)r=new XMLHttpRequest;else if(window.ActiveXObject)try{r=new window.ActiveXObject("Msxml2.XMLHTTP")}catch(e){r=new window.ActiveXObject("Microsoft.XMLHTTP")}var o=[];Object.keys(e).forEach(function(t){o.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]))}),r.open("POST",n.wtUrl,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onreadystatechange=function(){if(4===r.readyState){var e=r.response;e&&!n.sads[n.originalAdURL]&&(n.sads[n.originalAdURL]=e),"function"==typeof i&&i()}},r.send(o.join("&"))}else"function"==typeof i&&i()},this.getVisibleState=function(){t.log("start.getVisibleState");var e={percentObscured:0,percentViewable:0,acceptedViewablePercentage:50,viewabilityStatus:!1,duration:0,cssInvisible:!1,domObscured:!1,secureIFrame:!1},i=[];try{var r=n.videoSlot,o=r.getBoundingClientRect(),a=o.width*o.height;a>=242500&&(e.acceptedViewablePercentage=30);var l=window.getComputedStyle(r,null),d=l.getPropertyValue("visibility"),s=l.getPropertyValue("display");if("hidden"===d||"none"===s?(i.push("CSSInvisible TRUE"),e.cssInvisible=!0):i.push("CSSInvisible FALSE"),e.cssInvisible)return t.logGroup("getVisibleState 1",i),e;var c=o.left+12,h=o.right-12,g=o.top+12,p=o.bottom-12,u=Math.floor(o.left+o.width/2),w=Math.floor(o.top+o.height/2),v=[{x:c,y:g},{x:u,y:g},{x:h,y:g},{x:c,y:w},{x:u,y:w},{x:h,y:w},{x:c,y:p},{x:u,y:p},{x:h,y:p}],f=void 0,m=void 0,y=void 0,b=void 0;for(var _ in v)if(v.hasOwnProperty(_)&&v[_]&&v[_].x>=0&&v[_].y>=0&&null!==(f=document.elementFromPoint(v[_].x,v[_].y))&&f!==r&&!r.contains(f)&&(y=Math.max(0,Math.min(o.right,f.right)-Math.max(o.left,f.left)),b=Math.max(0,Math.min(o.bottom,f.bottom)-Math.max(o.top,f.top)),(m=y*b/a)>0&&(e.percentObscured=100*m,e.percentObscured>e.acceptedViewablePercentage))){e.percentViewable=100-e.percentObscured,e.domObscured=!0,i.push("DOM Obscured TRUE");break}e.percentObscured=e.percentObscured||0;var E={};try{window.top.innerWidth||window.top.document.documentElement.clientWidth||window.top.document.body.clientWidth?E=n.getSameDomainViewability(r):e.secureIFrame=!0}catch(t){e.secureIFrame=!0}return i.push(["Viewability Result:",E]),E.error||e.secureIFrame||(e.percentViewable=(E.verticalPer-e.percentObscured)*(E.horizontalPer-e.percentObscured)/100),i.push(["Full Viewability Check:",e]),t.logGroup("getVisibleState 2",i),e}catch(e){return i.push(["Full Viewability Check errored:",e.message]),t.logGroup("getVisibleState 3",i),{error:"Visibility check threw an error: "+e.message}}},this.getSameDomainViewability=function(e){t.log("start.getSameDomainViewability");var i=n.getViewPortSize(window.top),r=e.getBoundingClientRect(),o=-1,a=-1;if(i.area===1/0)return{error:"Failed to determine viewport"};var l=n.getPositionRelativeToViewPort(e,window);try{o=l.bottom<0||l.top>i.height?0:l.top<i.height&&l.bottom>i.height?(i.height-l.top)/r.height*100:l.top<0&&l.bottom>0?l.bottom/r.height*100:100,a=l.right<0||l.left>i.width?0:l.right<i.width&&l.left>i.width?(i.width-l.right)/r.width*100:l.left<0&&l.right>0?l.right/r.width*100:100}catch(e){return{error:"Failed to calculate viewability: "+e.message}}return{horizontalPer:a,verticalPer:o}},this.getViewPortSize=function(e){t.log("start.getViewPortSize");var i={width:1/0,height:1/0,area:1/0};return!isNaN(e.document.body.clientWidth)&&e.document.body.clientWidth>0&&(i.width=e.document.body.clientWidth),!isNaN(e.document.body.clientHeight)&&e.document.body.clientHeight>0&&(i.height=e.document.body.clientHeight),e.document.documentElement&&e.document.documentElement.clientWidth&&!isNaN(e.document.documentElement.clientWidth)&&(i.width=e.document.documentElement.clientWidth),e.document.documentElement&&e.document.documentElement.clientHeight&&!isNaN(e.document.documentElement.clientHeight)&&(i.height=e.document.documentElement.clientHeight),e.innerWidth&&!isNaN(e.innerWidth)&&(i.width=Math.min(i.width,e.innerWidth)),e.innerHeight&&!isNaN(e.innerHeight)&&(i.height=Math.min(i.height,e.innerHeight)),i.area=i.height*i.width,i},this.getPositionRelativeToViewPort=function(e,i){t.log("start.getPositionRelativeToViewPort");var r=i,o=i.parent,a={left:0,right:0,top:0,bottom:0};if(e){var l=e.getBoundingClientRect();r!==o&&(a=n.getPositionRelativeToViewPort(r.frameElement,o)),a={left:l.left+a.left,right:l.right+a.left,top:l.top+a.top,bottom:l.bottom+a.top}}return t.log("Got Position Relative to View Port for ",a),a},this.replaceUrlMacros=function(e){var t=n.gatherData();return e.replace(/\[wt_ad_width]/g,t.w).replace(/\[wt_ad_width_label]/g,"wt_ad_width").replace(/\[wt_ad_height]/g,t.h).replace(/\[wt_ad_height_label]/g,"wt_ad_height").replace(/\[wt_per]/g,t.per).replace(/\[wt_per_label]/g,"wt_per").replace(/\[wt_page_url]/g,encodeURIComponent(t.pu)).replace(/\[wt_page_url_unenc]/g,t.pu).replace(/\[wt_page_url_label]/g,"wt_page_url").replace(/\[wt_fif]/g,t.fif).replace(/\[wt_fif_label]/g,"wt_fif").replace(/\[wt_win_width]/g,t.ww).replace(/\[wt_win_width_label]/g,"wt_win_width").replace(/\[wt_win_height]/g,t.wh).replace(/\[wt_win_height_label]/g,"wt_win_height").replace(/\[wt_timestamp]/g,Date.now())},this.player=r,this.adManagerWrapper=o,this.options=a,l&&(this.wtUrl=l),this.sessionId=e.createSession(),this.debug=d,t.debug=d,t.log("version",this.options.wtVersion)}return e.prototype.start=function(){var i=this,r=function(){t.log("ads-request"),i.videoSlot=i.adManagerWrapper.videoSlot,i.sessionId=e.createSession(),i.originalAdURL=i.adManagerWrapper.adTagUrl,i.adManagerWrapper.adTagUrl=i.replaceUrlMacros(i.originalAdURL),i.player.options_&&i.player.options_["data-account"]&&i.player.options_["data-player"]&&(i.originalAdURL=i.player.options_["data-account"]+":"+i.player.options_["data-player"],i.originalAdURLIsPlayer=!0);var r=i.gatherData("plug");r.type="serve",r.adTech=i.adManagerWrapper.adTech,r.v=i.options.wtVersion;try{i.adManagerWrapper.wireVPAIDEvents(i.onVPAIDEvent)}catch(e){t.log("Unable to wire VPAID events",e)}i.sendDataToWT(r)};this.adManagerWrapper.ADS_REQ_EVENT?this.player.on(this.adManagerWrapper.ADS_REQ_EVENT,r):r(),this.adManagerWrapper.onAdError(this.onAdError)},e.createSession=function(){for(var e="",t=0;t<6;t++)e+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXZY01234567890".charAt(Math.floor(64*Math.random()));return e+"-"+Date.now()},e}(),a=function(){function e(t,r){i(this,e),this.SHORT_NAME="ntvp",this._onVPAIDEvent=function(t){return function(i){console.warn("_onVPAIDEvent e",i);var r=e.VPAID_EVENTS[i.type]||i.type;t(r,{},{})}},this.player=t,this.adServerUrl=r.adTagUrl,console.warn("vastObj",t.vast),console.warn("player",t)}return e.prototype.cleanup=function(){this.adServerUrl=null,this.player=null},e.prototype.wireVPAIDEvents=function(i){var r=this;t.log("start.wireEvents"),Object.keys(e.VPAID_EVENTS).forEach(function(e){r.player.on(e,r._onVPAIDEvent(i))})},e.prototype.onAdError=function(e){this.player.on("vast.adError",e)},r(e,[{key:"videoSlot",get:function(){return this.player.el().querySelector(".vjs-tech")}},{key:"adTech",get:function(){var e="html5";try{e=this.player.techName_.toLowerCase()}catch(e){}return e}},{key:"adTagUrl",get:function(){return this.adServerUrl},set:function(e){this.adServerUrl=e}}]),e}();a.VPAID_EVENTS={"vpaid.AdStarted":"sa","vpaid.AdImpression":"eimp","vpaid.AdVideoFirstQuartile":"efq","vpaid.AdVideoMidpoint":"esq","vpaid.AdVideoThirdQuartile":"etq","vpaid.AdVideoComplete":"ecp"};var n={},l=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=!1;try{i=!!localStorage.getItem("wtDebug")}catch(e){}if(void 0!==e.vast){i=t.wtDebug||i;var r=new a(e,t),n=new o(e,r,t,t.wtUrl||window.wtUrl,i);n.start(),i&&(window.wtat=n),e.addClass("vjs-wt-nativo-plugin")}},d=function(e){var t=this;this.ready(function(){l(t,videojs.mergeOptions(n,e,{wtVersion:"ntv-1.0.4"}))})};return(window.videojs.registerPlugin||window.videojs.plugin)("wtAdTracerNativoPlugin",d),d.VERSION="1.0.4",d});